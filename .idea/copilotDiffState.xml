<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/road_back/src/main/java/com/road/project/road_back/auth/controller/AuthController.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/road_back/src/main/java/com/road/project/road_back/auth/controller/AuthController.java" />
              <option name="originalContent" value="package com.road.project.road_back.auth.controller;&#10;&#10;import com.road.project.road_back.auth.dto.*;&#10;import com.road.project.road_back.auth.service.AuthService;&#10;import io.swagger.v3.oas.annotations.Operation;&#10;import io.swagger.v3.oas.annotations.responses.ApiResponse;&#10;import io.swagger.v3.oas.annotations.responses.ApiResponses;&#10;import io.swagger.v3.oas.annotations.security.SecurityRequirement;&#10;import io.swagger.v3.oas.annotations.tags.Tag;&#10;import jakarta.servlet.http.HttpServletRequest;&#10;import jakarta.validation.Valid;&#10;import lombok.RequiredArgsConstructor;&#10;import org.springframework.http.ResponseEntity;&#10;import org.springframework.security.access.prepost.PreAuthorize;&#10;import org.springframework.web.bind.annotation.*;&#10;&#10;import java.util.Map;&#10;&#10;/**&#10; * Contrôleur REST pour l'authentification.&#10; */&#10;@RestController&#10;@RequestMapping(&quot;/api/auth&quot;)&#10;@RequiredArgsConstructor&#10;@Tag(name = &quot;Authentification&quot;, description = &quot;API d'authentification et gestion des utilisateurs&quot;)&#10;public class AuthController {&#10;&#10;    private final AuthService authService;&#10;&#10;    @PostMapping(&quot;/register&quot;)&#10;    @Operation(summary = &quot;Inscription d'un nouvel utilisateur&quot;)&#10;    @ApiResponses(value = {&#10;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Inscription réussie&quot;),&#10;            @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Données invalides&quot;),&#10;            @ApiResponse(responseCode = &quot;409&quot;, description = &quot;Email déjà utilisé&quot;)&#10;    })&#10;    public ResponseEntity&lt;AuthResponse&gt; register(@Valid @RequestBody RegisterRequest request) {&#10;        return ResponseEntity.ok(authService.register(request));&#10;    }&#10;&#10;    @PostMapping(&quot;/login&quot;)&#10;    @Operation(summary = &quot;Connexion d'un utilisateur&quot;)&#10;    @ApiResponses(value = {&#10;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Connexion réussie&quot;),&#10;            @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Identifiants incorrects&quot;),&#10;            @ApiResponse(responseCode = &quot;423&quot;, description = &quot;Compte verrouillé&quot;)&#10;    })&#10;    public ResponseEntity&lt;AuthResponse&gt; login(&#10;            @Valid @RequestBody LoginRequest request,&#10;            HttpServletRequest httpRequest) {&#10;        String ipAddress = httpRequest.getRemoteAddr();&#10;        String userAgent = httpRequest.getHeader(&quot;User-Agent&quot;);&#10;        return ResponseEntity.ok(authService.login(request, ipAddress, userAgent));&#10;    }&#10;&#10;    @PostMapping(&quot;/logout&quot;)&#10;    @Operation(summary = &quot;Déconnexion de l'utilisateur&quot;, security = @SecurityRequirement(name = &quot;bearerAuth&quot;))&#10;    @ApiResponses(value = {&#10;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Déconnexion réussie&quot;),&#10;            @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Non authentifié&quot;)&#10;    })&#10;    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; logout(HttpServletRequest request) {&#10;        String token = extractToken(request);&#10;        if (token != null) {&#10;            authService.logout(token);&#10;        }&#10;        return ResponseEntity.ok(Map.of(&quot;message&quot;, &quot;Déconnexion réussie&quot;));&#10;    }&#10;&#10;    @PostMapping(&quot;/refresh&quot;)&#10;    @Operation(summary = &quot;Rafraîchir le token d'accès&quot;)&#10;    @ApiResponses(value = {&#10;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Token rafraîchi&quot;),&#10;            @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Refresh token invalide ou expiré&quot;)&#10;    })&#10;    public ResponseEntity&lt;AuthResponse&gt; refreshToken(@Valid @RequestBody RefreshTokenRequest request) {&#10;        return ResponseEntity.ok(authService.refreshToken(request));&#10;    }&#10;&#10;    @GetMapping(&quot;/profile&quot;)&#10;    @Operation(summary = &quot;Récupérer le profil de l'utilisateur connecté&quot;, security = @SecurityRequirement(name = &quot;bearerAuth&quot;))&#10;    @ApiResponses(value = {&#10;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Profil récupéré&quot;),&#10;            @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Non authentifié&quot;)&#10;    })&#10;    public ResponseEntity&lt;AuthResponse.UserDto&gt; getProfile() {&#10;        return ResponseEntity.ok(authService.getProfile());&#10;    }&#10;&#10;    @PutMapping(&quot;/profile&quot;)&#10;    @Operation(summary = &quot;Mettre à jour le profil de l'utilisateur&quot;, security = @SecurityRequirement(name = &quot;bearerAuth&quot;))&#10;    @ApiResponses(value = {&#10;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Profil mis à jour&quot;),&#10;            @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Données invalides&quot;),&#10;            @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Non authentifié&quot;)&#10;    })&#10;    public ResponseEntity&lt;AuthResponse.UserDto&gt; updateProfile(@Valid @RequestBody UpdateProfileRequest request) {&#10;        return ResponseEntity.ok(authService.updateProfile(request));&#10;    }&#10;&#10;    @PostMapping(&quot;/unlock/{email}&quot;)&#10;    @Operation(summary = &quot;Déverrouiller un compte utilisateur (public)&quot;)&#10;    @ApiResponses(value = {&#10;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Compte déverrouillé&quot;),&#10;            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Utilisateur non trouvé&quot;)&#10;    })&#10;    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; unlockAccount(@PathVariable String email) {&#10;        authService.unlockAccount(email);&#10;        return ResponseEntity.ok(Map.of(&quot;message&quot;, &quot;Compte déverrouillé avec succès&quot;));&#10;    }&#10;&#10;    @PostMapping(&quot;/admin/unlock/{userId}&quot;)&#10;    @PreAuthorize(&quot;hasRole('MANAGER')&quot;)&#10;    @Operation(summary = &quot;Déverrouiller un compte par le Manager&quot;, security = @SecurityRequirement(name = &quot;bearerAuth&quot;))&#10;    @ApiResponses(value = {&#10;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Compte déverrouillé&quot;),&#10;            @ApiResponse(responseCode = &quot;403&quot;, description = &quot;Accès refusé&quot;),&#10;            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Utilisateur non trouvé&quot;)&#10;    })&#10;    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; unlockAccountByManager(@PathVariable Long userId) {&#10;        authService.unlockAccountByManager(userId);&#10;        return ResponseEntity.ok(Map.of(&quot;message&quot;, &quot;Compte déverrouillé avec succès&quot;));&#10;    }&#10;&#10;    private String extractToken(HttpServletRequest request) {&#10;        String bearerToken = request.getHeader(&quot;Authorization&quot;);&#10;        if (bearerToken != null &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) {&#10;            return bearerToken.substring(7);&#10;        }&#10;        return null;&#10;    }&#10;}&#10;&#10;" />
              <option name="updatedContent" value="package com.road.project.road_back.auth.controller;&#10;&#10;import com.road.project.road_back.auth.dto.*;&#10;import com.road.project.road_back.auth.service.AuthService;&#10;import io.swagger.v3.oas.annotations.Operation;&#10;import io.swagger.v3.oas.annotations.responses.ApiResponse;&#10;import io.swagger.v3.oas.annotations.responses.ApiResponses;&#10;import io.swagger.v3.oas.annotations.security.SecurityRequirement;&#10;import io.swagger.v3.oas.annotations.tags.Tag;&#10;import jakarta.servlet.http.HttpServletRequest;&#10;import jakarta.validation.Valid;&#10;import lombok.RequiredArgsConstructor;&#10;import org.springframework.http.ResponseEntity;&#10;import org.springframework.security.access.prepost.PreAuthorize;&#10;import org.springframework.web.bind.annotation.*;&#10;&#10;import java.util.Map;&#10;&#10;/**&#10; * Contrôleur REST pour l'authentification.&#10; */&#10;@RestController&#10;@RequestMapping(&quot;/api/auth&quot;)&#10;@RequiredArgsConstructor&#10;@Tag(name = &quot;Authentification&quot;, description = &quot;API d'authentification et gestion des utilisateurs&quot;)&#10;public class AuthController {&#10;&#10;    private final AuthService authService;&#10;&#10;    @PostMapping(&quot;/register&quot;)&#10;    @Operation(summary = &quot;Inscription d'un nouvel utilisateur&quot;)&#10;    @ApiResponses(value = {&#10;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Inscription réussie&quot;),&#10;            @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Données invalides&quot;),&#10;            @ApiResponse(responseCode = &quot;409&quot;, description = &quot;Email déjà utilisé&quot;)&#10;    })&#10;    public ResponseEntity&lt;AuthResponse&gt; register(@Valid @RequestBody RegisterRequest request) {&#10;        return ResponseEntity.ok(authService.register(request));&#10;    }&#10;&#10;    @PostMapping(&quot;/login&quot;)&#10;    @Operation(summary = &quot;Connexion d'un utilisateur&quot;)&#10;    @ApiResponses(value = {&#10;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Connexion réussie&quot;),&#10;            @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Identifiants incorrects&quot;),&#10;            @ApiResponse(responseCode = &quot;423&quot;, description = &quot;Compte verrouillé&quot;)&#10;    })&#10;    public ResponseEntity&lt;AuthResponse&gt; login(&#10;            @Valid @RequestBody LoginRequest request,&#10;            HttpServletRequest httpRequest) {&#10;        String ipAddress = httpRequest.getRemoteAddr();&#10;        String userAgent = httpRequest.getHeader(&quot;User-Agent&quot;);&#10;        return ResponseEntity.ok(authService.login(request, ipAddress, userAgent));&#10;    }&#10;&#10;    @PostMapping(&quot;/logout&quot;)&#10;    @Operation(summary = &quot;Déconnexion de l'utilisateur&quot;, security = @SecurityRequirement(name = &quot;bearerAuth&quot;))&#10;    @ApiResponses(value = {&#10;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Déconnexion réussie&quot;),&#10;            @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Non authentifié&quot;)&#10;    })&#10;    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; logout(HttpServletRequest request) {&#10;        String token = extractToken(request);&#10;        if (token != null) {&#10;            authService.logout(token);&#10;        }&#10;        return ResponseEntity.ok(Map.of(&quot;message&quot;, &quot;Déconnexion réussie&quot;));&#10;    }&#10;&#10;    @PostMapping(&quot;/refresh&quot;)&#10;    @Operation(summary = &quot;Rafraîchir le token d'accès&quot;)&#10;    @ApiResponses(value = {&#10;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Token rafraîchi&quot;),&#10;            @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Refresh token invalide ou expiré&quot;)&#10;    })&#10;    public ResponseEntity&lt;AuthResponse&gt; refreshToken(@Valid @RequestBody RefreshTokenRequest request) {&#10;        return ResponseEntity.ok(authService.refreshToken(request));&#10;    }&#10;&#10;    @GetMapping(&quot;/profile&quot;)&#10;    @Operation(summary = &quot;Récupérer le profil de l'utilisateur connecté&quot;, security = @SecurityRequirement(name = &quot;bearerAuth&quot;))&#10;    @ApiResponses(value = {&#10;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Profil récupéré&quot;),&#10;            @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Non authentifié&quot;)&#10;    })&#10;    public ResponseEntity&lt;AuthResponse.UserDto&gt; getProfile() {&#10;        return ResponseEntity.ok(authService.getProfile());&#10;    }&#10;&#10;    @PutMapping(&quot;/profile&quot;)&#10;    @Operation(summary = &quot;Mettre à jour le profil de l'utilisateur&quot;, security = @SecurityRequirement(name = &quot;bearerAuth&quot;))&#10;    @ApiResponses(value = {&#10;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Profil mis à jour&quot;),&#10;            @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Données invalides&quot;),&#10;            @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Non authentifié&quot;)&#10;    })&#10;    public ResponseEntity&lt;AuthResponse.UserDto&gt; updateProfile(@Valid @RequestBody UpdateProfileRequest request) {&#10;        return ResponseEntity.ok(authService.updateProfile(request));&#10;    }&#10;&#10;    @PostMapping(&quot;/unlock/{email}&quot;)&#10;    @Operation(summary = &quot;Déverrouiller un compte utilisateur (public)&quot;)&#10;    @ApiResponses(value = {&#10;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Compte déverrouillé&quot;),&#10;            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Utilisateur non trouvé&quot;)&#10;    })&#10;    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; unlockAccount(@PathVariable String email) {&#10;        authService.unlockAccount(email);&#10;        return ResponseEntity.ok(Map.of(&quot;message&quot;, &quot;Compte déverrouillé avec succès&quot;));&#10;    }&#10;&#10;    @PostMapping(&quot;/admin/unlock/{userId}&quot;)&#10;    @PreAuthorize(&quot;hasRole('MANAGER')&quot;)&#10;    @Operation(summary = &quot;Déverrouiller un compte par le Manager&quot;, security = @SecurityRequirement(name = &quot;bearerAuth&quot;))&#10;    @ApiResponses(value = {&#10;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Compte déverrouillé&quot;),&#10;            @ApiResponse(responseCode = &quot;403&quot;, description = &quot;Accès refusé&quot;),&#10;            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Utilisateur non trouvé&quot;)&#10;    })&#10;    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; unlockAccountByManager(@PathVariable Long userId) {&#10;        authService.unlockAccountByManager(userId);&#10;        return ResponseEntity.ok(Map.of(&quot;message&quot;, &quot;Compte déverrouillé avec succès&quot;));&#10;    }&#10;&#10;    @GetMapping(&quot;/admin/users&quot;)&#10;    @PreAuthorize(&quot;hasAnyRole('MANAGER', 'ADMIN')&quot;)&#10;    @Operation(summary = &quot;Récupérer la liste de tous les utilisateurs&quot;, security = @SecurityRequirement(name = &quot;bearerAuth&quot;))&#10;    @ApiResponses(value = {&#10;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Liste des utilisateurs récupérée&quot;),&#10;            @ApiResponse(responseCode = &quot;403&quot;, description = &quot;Accès refusé&quot;)&#10;    })&#10;    public ResponseEntity&lt;java.util.List&lt;UserListResponse&gt;&gt; getAllUsers() {&#10;        return ResponseEntity.ok(authService.getAllUsers());&#10;    }&#10;&#10;    @PostMapping(&quot;/admin/users&quot;)&#10;    @PreAuthorize(&quot;hasAnyRole('MANAGER', 'ADMIN')&quot;)&#10;    @Operation(summary = &quot;Créer un nouvel utilisateur (par Manager/Admin)&quot;, security = @SecurityRequirement(name = &quot;bearerAuth&quot;))&#10;    @ApiResponses(value = {&#10;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Utilisateur créé&quot;),&#10;            @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Données invalides&quot;),&#10;            @ApiResponse(responseCode = &quot;403&quot;, description = &quot;Accès refusé&quot;),&#10;            @ApiResponse(responseCode = &quot;409&quot;, description = &quot;Email déjà utilisé&quot;)&#10;    })&#10;    public ResponseEntity&lt;UserListResponse&gt; createUser(@Valid @RequestBody CreateUserRequest request) {&#10;        return ResponseEntity.ok(authService.createUserByAdmin(request));&#10;    }&#10;&#10;    @GetMapping(&quot;/admin/users/{userId}&quot;)&#10;    @PreAuthorize(&quot;hasAnyRole('MANAGER', 'ADMIN')&quot;)&#10;    @Operation(summary = &quot;Récupérer un utilisateur par ID&quot;, security = @SecurityRequirement(name = &quot;bearerAuth&quot;))&#10;    @ApiResponses(value = {&#10;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Utilisateur récupéré&quot;),&#10;            @ApiResponse(responseCode = &quot;403&quot;, description = &quot;Accès refusé&quot;),&#10;            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Utilisateur non trouvé&quot;)&#10;    })&#10;    public ResponseEntity&lt;UserListResponse&gt; getUserById(@PathVariable Long userId) {&#10;        return ResponseEntity.ok(authService.getUserById(userId));&#10;    }&#10;&#10;    @DeleteMapping(&quot;/admin/users/{userId}&quot;)&#10;    @PreAuthorize(&quot;hasAnyRole('MANAGER', 'ADMIN')&quot;)&#10;    @Operation(summary = &quot;Supprimer un utilisateur&quot;, security = @SecurityRequirement(name = &quot;bearerAuth&quot;))&#10;    @ApiResponses(value = {&#10;            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Utilisateur supprimé&quot;),&#10;            @ApiResponse(responseCode = &quot;403&quot;, description = &quot;Accès refusé&quot;),&#10;            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Utilisateur non trouvé&quot;)&#10;    })&#10;    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; deleteUser(@PathVariable Long userId) {&#10;        authService.deleteUser(userId);&#10;        return ResponseEntity.ok(Map.of(&quot;message&quot;, &quot;Utilisateur supprimé avec succès&quot;));&#10;    }&#10;&#10;    private String extractToken(HttpServletRequest request) {&#10;        String bearerToken = request.getHeader(&quot;Authorization&quot;);&#10;        if (bearerToken != null &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) {&#10;            return bearerToken.substring(7);&#10;        }&#10;        return null;&#10;    }&#10;}&#10;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>